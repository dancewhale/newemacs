#+title:  Agenda View Setting
#+author: Dancewhale
#+date:   2024-12-16
#+tags: emacs org

A literate programming file for configuring org agenda view.

#+begin_src emacs-lisp :exports none
  ;;; cyz-agenda --- Configuring org for capturing notes. -*- lexical-binding: t; -*-
  ;;
  ;; © 2020-2024 Dancewhale
  ;;   Licensed under a Creative Commons Attribution 4.0 International License.
  ;;   See http://creativecommons.org/licenses/by/4.0/
  ;;
  ;; Author: Dancewhale
  ;; Maintainer: Dancewhale
  ;; Created: 2024-12-16
  ;;
  ;; This file is not part of GNU Emacs.
  ;;
  ;; *NB:* Do not edit this file. Instead, edit the original literate file at:
  ;;            ~/other/emacs.d/config/agenda.org
  ;;       And tangle the file to recreate this one.
  ;;
  ;;; Code:
#+end_src
* Introduction
这个配置文件用来配置我的agenda 相关配置.
* agenda 文件引入和跳转 
引入org-starter 包用来管理agenda file 的list.
#+name: org-starter
#+begin_src emacs-lisp  :comments link
  (straight-use-package 'org-starter)

  (use-package org-starter
    :config
    (org-starter-def "~/Dropbox/roam/gtd/"
      :files
      ("inbox.org"              :agenda t  :key "i" :refile (:maxlevel . 1))
      ("org-gtd-tasks.org"              :agenda t  :key "t" :refile (:maxlevel . 1))
      ))

  (general-define-key
    "C-c a"    #'org-agenda
    "s-e j i"  #'org-starter-find-file-by-key)
#+end_src
    
* org-gtd
#+name: gtd
#+begin_src emacs-lisp  :comments link
(straight-use-package 'org-gtd)
(require 'org-gtd)

(general-define-key
    "C-c n n"    #'org-gtd-capture
    "C-c n p"    #'org-gtd-process-inbox
    "C-c n o"    #'org-gtd-organize
    "C-c n e"    #'org-gtd-engage
    )

(setq org-gtd-directory (expand-file-name "~/Dropbox/roam/gtd"))
(setq org-gtd-update-ack "3.0.0")
#+end_src

* org-super-agenda
安装对应的包
#+name: super-agenda-package
#+begin_src emacs-lisp  :comments link
  (straight-use-package 'org-super-agenda)
  (require 'org-super-agenda)
#+end_src

设置对应的keyword
#+name: org-todo-keyword
#+begin_src emacs-lisp  :comments link
(setq org-todo-keywords
        '((sequence
           "TODO(t)"  ; A task that plan todo.
           "PROJ(p)"  ; An ongoing project that cannot be completed in one step
           "NEXT(n!)"  ; Something that is doing today.
           "WAIT(w@/!)"  ; Task should wait for some condition for ready.
           "|"
           "DONE(d!)"  ; Task successfully completed
           "CANC(c@/!)") ; Task was cancelled, aborted or is no longer applicable
          (sequence
           "QUESTION(q)"
           "LOGS(N)"
           "IDEA(i)"
           )))
   #+end_src



#+name:  super-agenda-config
#+begin_src emacs-lisp  :comments link
  (use-package org-super-agenda
    :config
    (add-hook 'after-init-hook 'org-super-agenda-mode)
    (require 'org-habit)
    (setq
     org-agenda-skip-timestamp-if-done t
     org-agenda-skip-deadline-if-done t
     org-agenda-skip-scheduled-if-done t
     org-agenda-skip-timestamp-if-dealine-is-shown t
     org-agenda-skip-additional-timestamps-same-entry t
     org-agenda-include-deadlines t
     org-agenda-include-diary t
     org-agenda-block-separator nil
     org-agenda-compact-blocks t
     org-agenda-start-with-log-mode t)
  )

  (setq org-agenda-custom-commands
      '(("z" "Super schema time view"
         ((alltodo "" ((org-agenda-overriding-header "")
                       (org-super-agenda-groups
                        '((:name "Next to do"
                                 :todo "NEXT"
                                 :order 1)
                          (:name "Important"
                                 :tag "Important"
                                 :priority "A"
                                 :order 6)
                          (:name "Due Today"
                                 :deadline today
                                 :order 2)
                          (:name "Due Soon"
                                 :deadline future
                                 :order 8)
                          (:name "Overdue"
                                 :deadline past
                                 :order 7)
                          (:name "Waiting"
                                 :todo "WAIT"
                                 :order 20)
                          (:name "trivial"
                                 :priority<= "C"
                                 :tag ("Trivial" "Unimportant")
                                 :todo ("SOMEDAY" )
                                 :order 90)
                           (:discard (:anything t))))))))))

#+end_src

* org-sql
#+name: org-ql
#+begin_src emacs-lisp  :comments link
  (straight-use-package 'org-ql)
  (require 'org-ql)
#+end_src

设置org-ql-view
#+name: org-ql-config
#+begin_src emacs-lisp  :comments link
(setq org-ql-views 
  (list (cons "Calendar: Next week"
              (lambda ()
                "Show items with an active timestamp during the next calendar week."
                (interactive)
                (let* ((ts (ts-adjust 'day 7 (ts-now)))
                       (beg-of-week (->> ts
                                         (ts-adjust 'day (- (ts-dow (ts-now))))
                                         (ts-apply :hour 0 :minute 0 :second 0)))
                       (end-of-week (->> ts
                                         (ts-adjust 'day (- 6 (ts-dow (ts-now))))
                                         (ts-apply :hour 23 :minute 59 :second 59))))
                  (org-ql-search (org-agenda-files)
                    `(ts-active :from ,beg-of-week
                                :to ,end-of-week)
                    :title "Next week"
                    :super-groups 'org-super-agenda-groups
                    :sort '(priority)))))
        (cons "Review: Recently timestamped" #'org-ql-view-recent-items)
        (cons (propertize "Review: Dangling tasks"
                          'help-echo "Tasks whose ancestor is done")
              (list :buffers-files #'org-agenda-files
                    :query '(and (todo)
                                 (ancestors (done)))
                    :title (propertize "Review: Dangling tasks"
                                       'help-echo "Tasks whose ancestor is done")
                    :sort '(todo priority date)
                    :super-groups '((:auto-parent t))))
        (cons (propertize "Review: Stale tasks"
                          'help-echo "Tasks without a timestamp in the past 2 weeks")
              (list :buffers-files #'org-agenda-files
                    :query '(and (todo)
                                 (not (ts :from -14)))
                    :title (propertize "Review: Stale tasks"
                                       'help-echo "Tasks without a timestamp in the past 2 weeks")
                    :sort '(todo priority date)
                    :super-groups '((:auto-parent t))))
        (cons (propertize "Review: Stuck projects"
                          'help-echo "Tasks with sub-tasks but no NEXT sub-tasks")
              (list :buffers-files #'org-agenda-files
                    :query '(and (todo)
                                 (descendants (todo "TODO" "DONE" "PROJ" "CANC"))
                                 (not (descendants (todo "NEXT"))))
                    :title (propertize "Review: Stuck projects"
                                       'help-echo "Tasks with sub-tasks but no NEXT sub-tasks")
                    :sort '(date priority)
                    :super-groups '((:auto-tags))))))
   #+end_src



* org-clock
** org-mru-clock
这个包支持选择clock 的历史历史记录
#+name: org-mru-clock
#+begin_src emacs-lisp  :comments link
  (straight-use-package 'org-mru-clock)

;; 支持clock 信息保存.
  (setq org-clock-persist t)
  (org-clock-persistence-insinuate)
  ;; Change task state to STARTED when clocking in
  (setq org-clock-in-switch-to-state "NEXT")
  ;; Removes clocked tasks with 0:00 duration
  (setq org-clock-out-remove-zero-time-clocks t)
#+end_src


** Tasks auto clock when start
[[https://janusworx.com/blog/what-i-learned-today-2023-02-10/][Mario Braganza]] had an interesting idea of starting the clock when a task changes to /in progress/:
#+name: org-todo-clock
#+begin_src emacs-lisp
  (defun cyz-org-clock-todo-change ()
    "Called from hook `org-after-todo-state-change-hook'.
  Clock in if a task changes to DOING (i.e. IN_PROGRESS),
  and clocks out with any other state change."
    (if (string= org-state "DOING")
        (org-clock-in)
      (org-clock-out-if-current)))

  (add-hook 'org-after-todo-state-change-hook 'cyz-org-clock-todo-change)
#+end_src
And I would like to have cute little icons for those states:



* beautiful
agenda 的时候启动olivetti-mode
#+name:
#+begin_src emacs-lisp  :comments link
  (defun org-agenda-open-hook ()
    "Hook to be run when org-agenda is opend."
    (olivetti-mode))

  (add-hook 'org-agenda-mode-hook 'org-agenda-open-hook)

  (setq org-agenda-time-grid '((daily) (600 1200 1800) " -----"  "-----"))
  (setq org-agenda-category-icon-alist
      `(("Teaching.p" ,(list (all-the-icons-faicon "graduation-cap" :height 0.8)) nil nil :ascent center)
        ("Family.s" ,(list (all-the-icons-faicon "home" :v-adjust 0.005)) nil nil :ascent center)
        ("Producer.p" ,(list (all-the-icons-faicon "youtube-play" :height 0.9)) nil nil :ascent center)
        ("Bard.p" ,(list (all-the-icons-faicon "music" :height 0.9)) nil nil :ascent center)
        ("Stories.s" ,(list (all-the-icons-faicon "book" :height 0.9)) nil nil :ascent center)
        ("Author.p" ,(list (all-the-icons-faicon "pencil" :height 0.9)) nil nil :ascent center)
        ("Gamedev.s" ,(list (all-the-icons-faicon "gamepad" :height 0.9)) nil nil :ascent center)
        ("Knowledge.p" ,(list (all-the-icons-faicon "database" :height 0.8)) nil nil :ascent center)
        ("Personal.p" ,(list (all-the-icons-material "person" :height 0.9)) nil nil :ascent center)))

  (setq org-agenda-prefix-format '(
    (agenda . "  %?-2i %t ")
     (todo . " %i %-12:c")
     (tags . " %i %-12:c")
     (search . " %i %-12:c")))
   #+end_src


* Technical Artifacts                                :noexport:
Let's provide a name so we can =require= this file.
#+begin_src emacs-lisp :exports none
  (provide 'cyz-agenda)
  ;;; cyz-agenda.el ends here
#+end_src

Before you can build this on a new system, make sure that you put the cursor over any of these properties, 
and hit: ~C-c C-c~

#+description: A literate programming file for configuring org agenda view.

#+property:    header-args:sh :tangle no
#+property:    header-args:emacs-lisp :tangle yes
#+property:    header-args    :results none :eval no-export :comments no mkdirp yes

#+options:     num:nil toc:t todo:nil tasks:nil tags:nil date:nil
#+options:     skip:nil author:nil email:nil creator:nil timestamp:nil
#+infojs_opt:  view:nil toc:t ltoc:t mouse:underline buttons:0 path:http://orgmode.org/org-info.js
